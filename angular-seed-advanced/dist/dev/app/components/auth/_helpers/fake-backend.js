"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var http_1 = require("@angular/http");
var testing_1 = require("@angular/http/testing");
function mockBackEndFactory(backend, options, realBackend) {
    var users = JSON.parse(localStorage.getItem('users')) || [];
    var token = 'fake-jwt-token';
    backend.connections.subscribe(function (connection) {
        setTimeout(function () {
            if (connection.request.url.endsWith('/api/authenticate') && connection.request.method === http_1.RequestMethod.Post) {
                var params_1 = JSON.parse(connection.request.getBody());
                var filteredUsers = users.filter(function (user) {
                    return user.email === params_1.email && user.password === params_1.password;
                });
                if (params_1.email === 'demo@demo.com' && params_1.password === 'demo') {
                    filteredUsers[0] = {
                        fullName: 'Demo',
                        email: 'demo@demo.com',
                        password: 'demo',
                    };
                }
                if (filteredUsers.length) {
                    var user = filteredUsers[0];
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({
                        status: 200,
                        body: {
                            id: user.id,
                            fullName: user.fullName,
                            email: user.email,
                            token: token
                        }
                    })));
                }
                else {
                    connection.mockError(new Error('Email or password is incorrect'));
                }
                return;
            }
            if (connection.request.url.endsWith('/api/users') && connection.request.method === http_1.RequestMethod.Get) {
                if (connection.request.headers.get('Authorization') === 'Bearer ' + token) {
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 200, body: users })));
                }
                else {
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 401 })));
                }
                return;
            }
            if (connection.request.url.match(/\/api\/users\/\d+$/) && connection.request.method === http_1.RequestMethod.Get) {
                if (connection.request.headers.get('Authorization') === 'Bearer ' + token) {
                    var urlParts = connection.request.url.split('/');
                    var id_1 = parseInt(urlParts[urlParts.length - 1]);
                    var matchedUsers = users.filter(function (user) {
                        return user.id === id_1;
                    });
                    var user = matchedUsers.length ? matchedUsers[0] : null;
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 200, body: user })));
                }
                else {
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 401 })));
                }
                return;
            }
            if (connection.request.url.endsWith('/api/users') && connection.request.method === http_1.RequestMethod.Post) {
                var newUser_1 = JSON.parse(connection.request.getBody());
                var duplicateUser = users.filter(function (user) {
                    return user.email === newUser_1.email;
                }).length;
                if (duplicateUser) {
                    return connection.mockError(new Error('Email "' + newUser_1.email + '" is already registered'));
                }
                newUser_1.id = users.length + 1;
                users.push(newUser_1);
                localStorage.setItem('users', JSON.stringify(users));
                connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 200 })));
                return;
            }
            if (connection.request.url.match(/\/api\/users\/\d+$/) && connection.request.method === http_1.RequestMethod.Delete) {
                if (connection.request.headers.get('Authorization') === 'Bearer ' + token) {
                    var urlParts = connection.request.url.split('/');
                    var id = parseInt(urlParts[urlParts.length - 1]);
                    for (var i = 0; i < users.length; i++) {
                        var user = users[i];
                        if (user.id === id) {
                            users.splice(i, 1);
                            localStorage.setItem('users', JSON.stringify(users));
                            break;
                        }
                    }
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 200 })));
                }
                else {
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 401 })));
                }
                return;
            }
            if (connection.request.url.endsWith('/api/verify') && connection.request.method === http_1.RequestMethod.Get) {
                if (connection.request.headers.get('Authorization') === 'Bearer ' + token) {
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 200, body: { status: 'ok' } })));
                }
                else {
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 401 })));
                }
                return;
            }
            if (connection.request.url.endsWith('/api/forgot-password') && connection.request.method === http_1.RequestMethod.Post) {
                var params_2 = JSON.parse(connection.request.getBody());
                var filteredUsers = users.filter(function (user) {
                    return user.email === params_2.email;
                });
                if (filteredUsers.length) {
                    var user = filteredUsers[0];
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 200 })));
                }
                else {
                    connection.mockError(new Error('User with this email does not exist'));
                }
                return;
            }
            var realHttp = new http_1.Http(realBackend, options);
            var requestOptions = new http_1.RequestOptions({
                method: connection.request.method,
                headers: connection.request.headers,
                body: connection.request.getBody(),
                url: connection.request.url,
                withCredentials: connection.request.withCredentials,
                responseType: connection.request.responseType
            });
            realHttp.request(connection.request.url, requestOptions)
                .subscribe(function (response) {
                connection.mockRespond(response);
            }, function (error) {
                connection.mockError(error);
            });
        }, 500);
    });
    return new http_1.Http(backend, options);
}
exports.mockBackEndFactory = mockBackEndFactory;
exports.fakeBackendProvider = {
    provide: http_1.Http,
    deps: [testing_1.MockBackend, http_1.BaseRequestOptions, http_1.XHRBackend],
    useFactory: mockBackEndFactory
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9jb21wb25lbnRzL2F1dGgvX2hlbHBlcnMvZmFrZS1iYWNrZW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQTZIO0FBQzdILGlEQUFrRTtBQUVsRSw0QkFBbUMsT0FBb0IsRUFBRSxPQUEyQixFQUFFLFdBQXVCO0lBRTVHLElBQUksS0FBSyxHQUFVLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUVuRSxJQUFJLEtBQUssR0FBVyxnQkFBZ0IsQ0FBQztJQUdyQyxPQUFPLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxVQUFDLFVBQTBCO1FBRXhELFVBQVUsQ0FBQztZQUdWLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTSxLQUFLLG9CQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFFOUcsSUFBSSxRQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7Z0JBR3RELElBQUksYUFBYSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBQSxJQUFJO29CQUNwQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxRQUFNLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssUUFBTSxDQUFDLFFBQVEsQ0FBQztnQkFDekUsQ0FBQyxDQUFDLENBQUM7Z0JBR0gsRUFBRSxDQUFDLENBQUMsUUFBTSxDQUFDLEtBQUssS0FBSyxlQUFlLElBQUksUUFBTSxDQUFDLFFBQVEsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUNwRSxhQUFhLENBQUMsQ0FBQyxDQUFDLEdBQUc7d0JBQ2xCLFFBQVEsRUFBRSxNQUFNO3dCQUNoQixLQUFLLEVB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RCxZQUFZLEVBQUUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxZQUFZO2FBQzdDLENBQUMsQ0FBQztZQUNILFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsY0FBYyxDQUFDO2lCQUN0RCxTQUFTLENBQUMsVUFBQyxRQUFrQjtnQkFDNUIsVUFBVSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNsQyxDQUFDLEVBQ0QsVUFBQyxLQUFVO2dCQUNWLFVBQVUsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDN0IsQ0FBQyxDQUFDLENBQUM7UUFFTixDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFFVCxDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sQ0FBQyxJQUFJLFdBQUksQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDbkMsQ0FBQztBQXBNRCxnREFvTUM7QUFFVSxRQUFBLG1CQUFtQixHQUFHO0lBRWhDLE9BQU8sRUFBRSxXQUFJO0lBQ2IsSUFBSSxFQUFFLENBQUMscUJBQVcsRUFBRSx5QkFBa0IsRUFBRSxpQkFBVSxDQUFDO0lBQ25ELFVBQVUsRUFBRSxrQkFBa0I7Q0FDOUIsQ0FBQyIsImZpbGUiOiJhcHAvY29tcG9uZW50cy9hdXRoL19oZWxwZXJzL2Zha2UtYmFja2VuZC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7QmFzZVJlcXVlc3RPcHRpb25zLCBIdHRwLCBSZXF1ZXN0TWV0aG9kLCBSZXF1ZXN0T3B0aW9ucywgUmVzcG9uc2UsIFJlc3BvbnNlT3B0aW9ucywgWEhSQmFja2VuZH0gZnJvbSBcIkBhbmd1bGFyL2h0dHBcIjtcclxuaW1wb3J0IHtNb2NrQmFja2VuZCwgTW9ja0Nvbm5lY3Rpb259IGZyb20gXCJAYW5ndWxhci9odHRwL3Rlc3RpbmdcIjtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBtb2NrQmFja0VuZEZhY3RvcnkoYmFja2VuZDogTW9ja0JhY2tlbmQsIG9wdGlvbnM6IEJhc2VSZXF1ZXN0T3B0aW9ucywgcmVhbEJhY2tlbmQ6IFhIUkJhY2tlbmQpIHtcclxuXHQvLyBhcnJheSBpbiBsb2NhbCBzdG9yYWdlIGZvciByZWdpc3RlcmVkIHVzZXJzXHJcblx0bGV0IHVzZXJzOiBhbnlbXSA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3VzZXJzJykpIHx8IFtdO1xyXG5cdC8vIGZha2UgdG9rZW5cclxuXHRsZXQgdG9rZW46IHN0cmluZyA9ICdmYWtlLWp3dC10b2tlbic7XHJcblxyXG5cdC8vIGNvbmZpZ3VyZSBmYWtlIGJhY2tlbmRcclxuXHRiYWNrZW5kLmNvbm5lY3Rpb25zLnN1YnNjcmliZSgoY29ubmVjdGlvbjogTW9ja0Nvbm5lY3Rpb24pID0+IHtcclxuXHRcdC8vIHdyYXAgaW4gdGltZW91dCB0byBzaW11bGF0ZSBzZXJ2ZXIgYXBpIGNhbGxcclxuXHRcdHNldFRpbWVvdXQoKCkgPT4ge1xyXG5cclxuXHRcdFx0Ly8gYXV0aGVudGljYXRlXHJcblx0XHRcdGlmIChjb25uZWN0aW9uLnJlcXVlc3QudXJsLmVuZHNXaXRoKCcvYXBpL2F1dGhlbnRpY2F0ZScpICYmIGNvbm5lY3Rpb24ucmVxdWVzdC5tZXRob2QgPT09IFJlcXVlc3RNZXRob2QuUG9zdCkge1xyXG5cdFx0XHRcdC8vIGdldCBwYXJhbWV0ZXJzIGZyb20gcG9zdCByZXF1ZXN0XHJcblx0XHRcdFx0bGV0IHBhcmFtcyA9IEpTT04ucGFyc2UoY29ubmVjdGlvbi5yZXF1ZXN0LmdldEJvZHkoKSk7XHJcblxyXG5cdFx0XHRcdC8vIGZpbmQgaWYgYW55IHVzZXIgbWF0Y2hlcyBsb2dpbiBjcmVkZW50aWFsc1xyXG5cdFx0XHRcdGxldCBmaWx0ZXJlZFVzZXJzID0gdXNlcnMuZmlsdGVyKHVzZXIgPT4ge1xyXG5cdFx0XHRcdFx0cmV0dXJuIHVzZXIuZW1haWwgPT09IHBhcmFtcy5lbWFpbCAmJiB1c2VyLnBhc3N3b3JkID09PSBwYXJhbXMucGFzc3dvcmQ7XHJcblx0XHRcdFx0fSk7XHJcblxyXG5cdFx0XHRcdC8vIGRlZmF1bHQgYWNjb3VudFxyXG5cdFx0XHRcdGlmIChwYXJhbXMuZW1haWwgPT09ICdkZW1vQGRlbW8uY29tJyAmJiBwYXJhbXMucGFzc3dvcmQgPT09ICdkZW1vJykge1xyXG5cdFx0XHRcdFx0ZmlsdGVyZWRVc2Vyc1swXSA9IHtcclxuXHRcdFx0XHRcdFx0ZnVsbE5hbWU6ICdEZW1vJyxcclxuXHRcdFx0XHRcdFx0ZW1haWw6ICdkZW1vQGRlbW8uY29tJyxcclxuXHRcdFx0XHRcdFx0cGFzc3dvcmQ6ICdkZW1vJyxcclxuXHRcdFx0XHRcdH07XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRpZiAoZmlsdGVyZWRVc2Vycy5sZW5ndGgpIHtcclxuXHRcdFx0XHRcdC8vIGlmIGxvZ2luIGRldGFpbHMgYXJlIHZhbGlkIHJldHVybiAyMDAgT0sgd2l0aCB1c2VyIGRldGFpbHMgYW5kIGZha2Ugand0IHRva2VuXHJcblx0XHRcdFx0XHRsZXQgdXNlciA9IGZpbHRlcmVkVXNlcnNbMF07XHJcblx0XHRcdFx0XHRjb25uZWN0aW9uLm1vY2tSZXNwb25kKG5ldyBSZXNwb25zZShuZXcgUmVzcG9uc2VPcHRpb25zKHtcclxuXHRcdFx0XHRcdFx0c3RhdHVzOiAyMDAsXHJcblx0XHRcdFx0XHRcdGJvZHk6IHtcclxuXHRcdFx0XHRcdFx0XHRpZDogdXNlci5pZCxcclxuXHRcdFx0XHRcdFx0XHRmdWxsTmFtZTogdXNlci5mdWxsTmFtZSxcclxuXHRcdFx0XHRcdFx0XHRlbWFpbDogdXNlci5lbWFpbCxcclxuXHRcdFx0XHRcdFx0XHR0b2tlbjogdG9rZW5cclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fSkpKTtcclxuXHRcdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdFx0Ly8gZWxzZSByZXR1cm4gNDAwIGJhZCByZXF1ZXN0XHJcblx0XHRcdFx0XHRjb25uZWN0aW9uLm1vY2tFcnJvcihuZXcgRXJyb3IoJ0VtYWlsIG9yIHBhc3N3b3JkIGlzIGluY29ycmVjdCcpKTtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdHJldHVybjtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gZ2V0IHVzZXJzXHJcblx0XHRcdGlmIChjb25uZWN0aW9uLnJlcXVlc3QudXJsLmVuZHNXaXRoKCcvYXBpL3VzZXJzJykgJiYgY29ubmVjdGlvbi5yZXF1ZXN0Lm1ldGhvZCA9PT0gUmVxdWVzdE1ldGhvZC5HZXQpIHtcclxuXHRcdFx0XHQvLyBjaGVjayBmb3IgZmFrZSBhdXRoIHRva2VuIGluIGhlYWRlciBhbmQgcmV0dXJuIHVzZXJzIGlmIHZhbGlkLCB0aGlzIHNlY3VyaXR5XHJcblx0XHRcdFx0Ly8gaXMgaW1wbGVtZW50ZWQgc2VydmVyIHNpZGUgaW4gYSByZWFsIGFwcGxpY2F0aW9uXHJcblx0XHRcdFx0aWYgKGNvbm5lY3Rpb24ucmVxdWVzdC5oZWFkZXJzLmdldCgnQXV0aG9yaXphdGlvbicpID09PSAnQmVhcmVyICcgKyB0b2tlbikge1xyXG5cdFx0XHRcdFx0Y29ubmVjdGlvbi5tb2NrUmVzcG9uZChuZXcgUmVzcG9uc2UobmV3IFJlc3BvbnNlT3B0aW9ucyh7c3RhdHVzOiAyMDAsIGJvZHk6IHVzZXJzfSkpKTtcclxuXHRcdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdFx0Ly8gcmV0dXJuIDQwMSBub3QgYXV0aG9yaXNlZCBpZiB0b2tlbiBpcyBudWxsIG9yIGludmFsaWRcclxuXHRcdFx0XHRcdGNvbm5lY3Rpb24ubW9ja1Jlc3BvbmQobmV3IFJlc3BvbnNlKG5ldyBSZXNwb25zZU9wdGlvbnMoe3N0YXR1czogNDAxfSkpKTtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdHJldHVybjtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gZ2V0IHVzZXIgYnkgaWRcclxuXHRcdFx0aWYgKGNvbm5lY3Rpb24ucmVxdWVzdC51cmwubWF0Y2goL1xcL2FwaVxcL3VzZXJzXFwvXFxkKyQvKSAmJiBjb25uZWN0aW9uLnJlcXVlc3QubWV0aG9kID09PSBSZXF1ZXN0TWV0aG9kLkdldCkge1xyXG5cdFx0XHRcdC8vIGNoZWNrIGZvciBmYWtlIGF1dGggdG9rZW4gaW4gaGVhZGVyIGFuZCByZXR1cm4gdXNlciBpZiB2YWxpZCwgdGhpcyBzZWN1cml0eSBpcyBpbXBsZW1lbnRlZCBzZXJ2ZXIgc2lkZSBpbiBhIHJlYWwgYXBwbGljYXRpb25cclxuXHRcdFx0XHRpZiAoY29ubmVjdGlvbi5yZXF1ZXN0LmhlYWRlcnMuZ2V0KCdBdXRob3JpemF0aW9uJykgPT09ICdCZWFyZXIgJyArIHRva2VuKSB7XHJcblx0XHRcdFx0XHQvLyBmaW5kIHVzZXIgYnkgaWQgaW4gdXNlcnMgYXJyYXlcclxuXHRcdFx0XHRcdGxldCB1cmxQYXJ0cyA9IGNvbm5lY3Rpb24ucmVxdWVzdC51cmwuc3BsaXQoJy8nKTtcclxuXHRcdFx0XHRcdGxldCBpZCA9IHBhcnNlSW50KHVybFBhcnRzW3VybFBhcnRzLmxlbmd0aCAtIDFdKTtcclxuXHRcdFx0XHRcdGxldCBtYXRjaGVkVXNlcnMgPSB1c2Vycy5maWx0ZXIodXNlciA9PiB7XHJcblx0XHRcdFx0XHRcdHJldHVybiB1c2VyLmlkID09PSBpZDtcclxuXHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0bGV0IHVzZXIgPSBtYXRjaGVkVXNlcnMubGVuZ3RoID8gbWF0Y2hlZFVzZXJzWzBdIDogbnVsbDtcclxuXHJcblx0XHRcdFx0XHQvLyByZXNwb25kIDIwMCBPSyB3aXRoIHVzZXJcclxuXHRcdFx0XHRcdGNvbm5lY3Rpb24ubW9ja1Jlc3BvbmQobmV3IFJlc3BvbnNlKG5ldyBSZXNwb25zZU9wdGlvbnMoe3N0YXR1czogMjAwLCBib2R5OiB1c2VyfSkpKTtcclxuXHRcdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdFx0Ly8gcmV0dXJuIDQwMSBub3QgYXV0aG9yaXNlZCBpZiB0b2tlbiBpcyBudWxsIG9yIGludmFsaWRcclxuXHRcdFx0XHRcdGNvbm5lY3Rpb24ubW9ja1Jlc3BvbmQobmV3IFJlc3BvbnNlKG5ldyBSZXNwb25zZU9wdGlvbnMoe3N0YXR1czogNDAxfSkpKTtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdHJldHVybjtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gY3JlYXRlIHVzZXJcclxuXHRcdFx0aWYgKGNvbm5lY3Rpb24ucmVxdWVzdC51cmwuZW5kc1dpdGgoJy9hcGkvdXNlcnMnKSAmJiBjb25uZWN0aW9uLnJlcXVlc3QubWV0aG9kID09PSBSZXF1ZXN0TWV0aG9kLlBvc3QpIHtcclxuXHRcdFx0XHQvLyBnZXQgbmV3IHVzZXIgb2JqZWN0IGZyb20gcG9zdCBib2R5XHJcblx0XHRcdFx0bGV0IG5ld1VzZXIgPSBKU09OLnBhcnNlKGNvbm5lY3Rpb24ucmVxdWVzdC5nZXRCb2R5KCkpO1xyXG5cclxuXHRcdFx0XHQvLyB2YWxpZGF0aW9uXHJcblx0XHRcdFx0bGV0IGR1cGxpY2F0ZVVzZXIgPSB1c2Vycy5maWx0ZXIodXNlciA9PiB7XHJcblx0XHRcdFx0XHRyZXR1cm4gdXNlci5lbWFpbCA9PT0gbmV3VXNlci5lbWFpbDtcclxuXHRcdFx0XHR9KS5sZW5ndGg7XHJcblx0XHRcdFx0aWYgKGR1cGxpY2F0ZVVzZXIpIHtcclxuXHRcdFx0XHRcdHJldHVybiBjb25uZWN0aW9uLm1vY2tFcnJvcihuZXcgRXJyb3IoJ0VtYWlsIFwiJyArIG5ld1VzZXIuZW1haWwgKyAnXCIgaXMgYWxyZWFkeSByZWdpc3RlcmVkJykpO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0Ly8gc2F2ZSBuZXcgdXNlclxyXG5cdFx0XHRcdG5ld1VzZXIuaWQgPSB1c2Vycy5sZW5ndGggKyAxO1xyXG5cdFx0XHRcdHVzZXJzLnB1c2gobmV3VXNlcik7XHJcblx0XHRcdFx0bG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3VzZXJzJywgSlNPTi5zdHJpbmdpZnkodXNlcnMpKTtcclxuXHJcblx0XHRcdFx0Ly8gcmVzcG9uZCAyMDAgT0tcclxuXHRcdFx0XHRjb25uZWN0aW9uLm1vY2tSZXNwb25kKG5ldyBSZXNwb25zZShuZXcgUmVzcG9uc2VPcHRpb25zKHtzdGF0dXM6IDIwMH0pKSk7XHJcblxyXG5cdFx0XHRcdHJldHVybjtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gZGVsZXRlIHVzZXJcclxuXHRcdFx0aWYgKGNvbm5lY3Rpb24ucmVxdWVzdC51cmwubWF0Y2goL1xcL2FwaVxcL3VzZXJzXFwvXFxkKyQvKSAmJiBjb25uZWN0aW9uLnJlcXVlc3QubWV0aG9kID09PSBSZXF1ZXN0TWV0aG9kLkRlbGV0ZSkge1xyXG5cdFx0XHRcdC8vIGNoZWNrIGZvciBmYWtlIGF1dGggdG9rZW4gaW4gaGVhZGVyIGFuZCByZXR1cm4gdXNlciBpZiB2YWxpZCwgdGhpcyBzZWN1cml0eSBpcyBpbXBsZW1lbnRlZCBzZXJ2ZXIgc2lkZSBpbiBhIHJlYWwgYXBwbGljYXRpb25cclxuXHRcdFx0XHRpZiAoY29ubmVjdGlvbi5yZXF1ZXN0LmhlYWRlcnMuZ2V0KCdBdXRob3JpemF0aW9uJykgPT09ICdCZWFyZXIgJyArIHRva2VuKSB7XHJcblx0XHRcdFx0XHQvLyBmaW5kIHVzZXIgYnkgaWQgaW4gdXNlcnMgYXJyYXlcclxuXHRcdFx0XHRcdGxldCB1cmxQYXJ0cyA9IGNvbm5lY3Rpb24ucmVxdWVzdC51cmwuc3BsaXQoJy8nKTtcclxuXHRcdFx0XHRcdGxldCBpZCA9IHBhcnNlSW50KHVybFBhcnRzW3VybFBhcnRzLmxlbmd0aCAtIDFdKTtcclxuXHRcdFx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgdXNlcnMubGVuZ3RoOyBpKyspIHtcclxuXHRcdFx0XHRcdFx0bGV0IHVzZXIgPSB1c2Vyc1tpXTtcclxuXHRcdFx0XHRcdFx0aWYgKHVzZXIuaWQgPT09IGlkKSB7XHJcblx0XHRcdFx0XHRcdFx0Ly8gZGVsZXRlIHVzZXJcclxuXHRcdFx0XHRcdFx0XHR1c2Vycy5zcGxpY2UoaSwgMSk7XHJcblx0XHRcdFx0XHRcdFx0bG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3VzZXJzJywgSlNPTi5zdHJpbmdpZnkodXNlcnMpKTtcclxuXHRcdFx0XHRcdFx0XHRicmVhaztcclxuXHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRcdC8vIHJlc3BvbmQgMjAwIE9LXHJcblx0XHRcdFx0XHRjb25uZWN0aW9uLm1vY2tSZXNwb25kKG5ldyBSZXNwb25zZShuZXcgUmVzcG9uc2VPcHRpb25zKHtzdGF0dXM6IDIwMH0pKSk7XHJcblx0XHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRcdC8vIHJldHVybiA0MDEgbm90IGF1dGhvcmlzZWQgaWYgdG9rZW4gaXMgbnVsbCBvciBpbnZhbGlkXHJcblx0XHRcdFx0XHRjb25uZWN0aW9uLm1vY2tSZXNwb25kKG5ldyBSZXNwb25zZShuZXcgUmVzcG9uc2VPcHRpb25zKHtzdGF0dXM6IDQwMX0pKSk7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdC8vIHRva2VuIHZlcmlmeVxyXG5cdFx0XHRpZiAoY29ubmVjdGlvbi5yZXF1ZXN0LnVybC5lbmRzV2l0aCgnL2FwaS92ZXJpZnknKSAmJiBjb25uZWN0aW9uLnJlcXVlc3QubWV0aG9kID09PSBSZXF1ZXN0TWV0aG9kLkdldCkge1xyXG5cdFx0XHRcdC8vIGNoZWNrIGZvciBmYWtlIGF1dGggdG9rZW4gaW4gaGVhZGVyIGFuZCByZXR1cm4gdXNlcnMgaWYgdmFsaWQsIHRoaXMgc2VjdXJpdHlcclxuXHRcdFx0XHQvLyBpcyBpbXBsZW1lbnRlZCBzZXJ2ZXIgc2lkZSBpbiBhIHJlYWwgYXBwbGljYXRpb25cclxuXHRcdFx0XHRpZiAoY29ubmVjdGlvbi5yZXF1ZXN0LmhlYWRlcnMuZ2V0KCdBdXRob3JpemF0aW9uJykgPT09ICdCZWFyZXIgJyArIHRva2VuKSB7XHJcblx0XHRcdFx0XHRjb25uZWN0aW9uLm1vY2tSZXNwb25kKG5ldyBSZXNwb25zZShuZXcgUmVzcG9uc2VPcHRpb25zKHtzdGF0dXM6IDIwMCwgYm9keToge3N0YXR1czogJ29rJ319KSkpO1xyXG5cdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHQvLyByZXR1cm4gNDAxIG5vdCBhdXRob3Jpc2VkIGlmIHRva2VuIGlzIG51bGwgb3IgaW52YWxpZFxyXG5cdFx0XHRcdFx0Y29ubmVjdGlvbi5tb2NrUmVzcG9uZChuZXcgUmVzcG9uc2UobmV3IFJlc3BvbnNlT3B0aW9ucyh7c3RhdHVzOiA0MDF9KSkpO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0cmV0dXJuO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHQvLyBmb3Jnb3QgcGFzc3dvcmRcclxuXHRcdFx0aWYgKGNvbm5lY3Rpb24ucmVxdWVzdC51cmwuZW5kc1dpdGgoJy9hcGkvZm9yZ290LXBhc3N3b3JkJykgJiYgY29ubmVjdGlvbi5yZXF1ZXN0Lm1ldGhvZCA9PT0gUmVxdWVzdE1ldGhvZC5Qb3N0KSB7XHJcblx0XHRcdFx0Ly8gZ2V0IHBhcmFtZXRlcnMgZnJvbSBwb3N0IHJlcXVlc3RcclxuXHRcdFx0XHRsZXQgcGFyYW1zID0gSlNPTi5wYXJzZShjb25uZWN0aW9uLnJlcXVlc3QuZ2V0Qm9keSgpKTtcclxuXHJcblx0XHRcdFx0Ly8gZmluZCBpZiBhbnkgdXNlciBtYXRjaGVzIGxvZ2luIGNyZWRlbnRpYWxzXHJcblx0XHRcdFx0bGV0IGZpbHRlcmVkVXNlcnMgPSB1c2Vycy5maWx0ZXIodXNlciA9PiB7XHJcblx0XHRcdFx0XHRyZXR1cm4gdXNlci5lbWFpbCA9PT0gcGFyYW1zLmVtYWlsO1xyXG5cdFx0XHRcdH0pO1xyXG5cclxuXHRcdFx0XHRpZiAoZmlsdGVyZWRVc2Vycy5sZW5ndGgpIHtcclxuXHRcdFx0XHRcdC8vIGluIHJlYWwgd29ybGQsIGlmIGVtYWlsIGlzIHZhbGlkLCBzZW5kIGVtYWlsIGNoYW5nZSBwYXNzd29yZCBsaW5rXHJcblx0XHRcdFx0XHRsZXQgdXNlciA9IGZpbHRlcmVkVXNlcnNbMF07XHJcblx0XHRcdFx0XHRjb25uZWN0aW9uLm1vY2tSZXNwb25kKG5ldyBSZXNwb25zZShuZXcgUmVzcG9uc2VPcHRpb25zKHtzdGF0dXM6IDIwMH0pKSk7XHJcblx0XHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRcdC8vIGVsc2UgcmV0dXJuIDQwMCBiYWQgcmVxdWVzdFxyXG5cdFx0XHRcdFx0Y29ubmVjdGlvbi5tb2NrRXJyb3IobmV3IEVycm9yKCdVc2VyIHdpdGggdGhpcyBlbWFpbCBkb2VzIG5vdCBleGlzdCcpKTtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdHJldHVybjtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gcGFzcyB0aHJvdWdoIGFueSByZXF1ZXN0cyBub3QgaGFuZGxlZCBhYm92ZVxyXG5cdFx0XHRsZXQgcmVhbEh0dHAgPSBuZXcgSHR0cChyZWFsQmFja2VuZCwgb3B0aW9ucyk7XHJcblx0XHRcdGxldCByZXF1ZXN0T3B0aW9ucyA9IG5ldyBSZXF1ZXN0T3B0aW9ucyh7XHJcblx0XHRcdFx0bWV0aG9kOiBjb25uZWN0aW9uLnJlcXVlc3QubWV0aG9kLFxyXG5cdFx0XHRcdGhlYWRlcnM6IGNvbm5lY3Rpb24ucmVxdWVzdC5oZWFkZXJzLFxyXG5cdFx0XHRcdGJvZHk6IGNvbm5lY3Rpb24ucmVxdWVzdC5nZXRCb2R5KCksXHJcblx0XHRcdFx0dXJsOiBjb25uZWN0aW9uLnJlcXVlc3QudXJsLFxyXG5cdFx0XHRcdHdpdGhDcmVkZW50aWFsczogY29ubmVjdGlvbi5yZXF1ZXN0LndpdGhDcmVkZW50aWFscyxcclxuXHRcdFx0XHRyZXNwb25zZVR5cGU6IGNvbm5lY3Rpb24ucmVxdWVzdC5yZXNwb25zZVR5cGVcclxuXHRcdFx0fSk7XHJcblx0XHRcdHJlYWxIdHRwLnJlcXVlc3QoY29ubmVjdGlvbi5yZXF1ZXN0LnVybCwgcmVxdWVzdE9wdGlvbnMpXHJcblx0XHRcdFx0LnN1YnNjcmliZSgocmVzcG9uc2U6IFJlc3BvbnNlKSA9PiB7XHJcblx0XHRcdFx0XHRcdGNvbm5lY3Rpb24ubW9ja1Jlc3BvbmQocmVzcG9uc2UpO1xyXG5cdFx0XHRcdFx0fSxcclxuXHRcdFx0XHRcdChlcnJvcjogYW55KSA9PiB7XHJcblx0XHRcdFx0XHRcdGNvbm5lY3Rpb24ubW9ja0Vycm9yKGVycm9yKTtcclxuXHRcdFx0XHRcdH0pO1xyXG5cclxuXHRcdH0sIDUwMCk7XHJcblxyXG5cdH0pO1xyXG5cclxuXHRyZXR1cm4gbmV3IEh0dHAoYmFja2VuZCwgb3B0aW9ucyk7XHJcbn1cclxuXHJcbmV4cG9ydCBsZXQgZmFrZUJhY2tlbmRQcm92aWRlciA9IHtcclxuXHQvLyB1c2UgZmFrZSBiYWNrZW5kIGluIHBsYWNlIG9mIEh0dHAgc2VydmljZSBmb3IgYmFja2VuZC1sZXNzIGRldmVsb3BtZW50XHJcblx0cHJvdmlkZTogSHR0cCxcclxuXHRkZXBzOiBbTW9ja0JhY2tlbmQsIEJhc2VSZXF1ZXN0T3B0aW9ucywgWEhSQmFja2VuZF0sXHJcblx0dXNlRmFjdG9yeTogbW9ja0JhY2tFbmRGYWN0b3J5XHJcbn07Il19
